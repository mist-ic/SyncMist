name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  ci:
    name: Moon CI
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: moonrepo/setup-toolchain@v0
        with:
          auto-install: true

      # Install languages not managed by proto
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'
          channel: 'stable'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      # Install dependencies
      - name: Install Dependencies
        run: |
          cd apps/server && go mod download
          cd ../flutter_app && flutter pub get
          cd ../../packages/rust_core && cargo fetch

      # Run moon CI (affected tasks only)
      - run: moon ci

  # Fallback individual builds if moon ci has issues
  build-go:
    name: Build Go (Fallback)
    runs-on: ubuntu-latest
    if: failure()
    needs: ci
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      - run: cd apps/server && go build ./cmd/server

  build-rust:
    name: Build Rust (Fallback)
    runs-on: ubuntu-latest
    if: failure()
    needs: ci
    
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cd packages/rust_core && cargo build && cargo test
